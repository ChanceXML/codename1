name: Source Code Sync

on:
  workflow_dispatch:
    inputs:
      tag_version:
        description: 'The tag version to download (e.g., v1.0.1)'
        required: true
        default: 'v1.0.1'
      website:
        description: 'GitHub repository URL (e.g., https://github.com/username/repo)'
        required: true
      target_dir:
        description: 'Target folder to merge source into'
        required: true
        default: '.' 
      skip_folders:
        description: 'Number of top-level folders to skip in the ZIP (auto-detect if left empty)'
        required: false
        default: ''

jobs:
  download-and-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Show Inputs
        run: |
          echo "Tag Version: ${{ github.event.inputs.tag_version }}"
          echo "Website: ${{ github.event.inputs.website }}"
          echo "Target Directory: ${{ github.event.inputs.target_dir }}"
          echo "Skip Folders: ${{ github.event.inputs.skip_folders }}"

      - name: Download Release
        run: |
          TAG="${{ github.event.inputs.tag_version }}"
          REPO="${{ github.event.inputs.website }}"
          ENCODED_TAG="${TAG// /%20}"
          REPO_NAME=$(basename -s .git "$REPO")
          URL="$REPO/archive/refs/tags/${ENCODED_TAG}.zip"
          echo "Downloading release from: $URL"
          curl -L -o source.zip "$URL"

      - name: Extract and Merge
        run: |
          mkdir temp_extract
          unzip source.zip -d temp_extract
          
          TARGET="${{ github.event.inputs.target_dir }}"
          mkdir -p "$TARGET"

          FOLDER="temp_extract"
          SKIP="${{ github.event.inputs.skip_folders }}"

          if [ -z "$SKIP" ]; then
              COUNT=$(ls -1 "$FOLDER" | wc -l)
              if [ "$COUNT" -eq 1 ] && [ -d "$FOLDER/$(ls -1 $FOLDER)" ]; then
                  FOLDER="$FOLDER/$(ls -1 $FOLDER)"
                  echo "Only one folder detected, entering: $FOLDER"
              fi
          else
              for i in $(seq 1 $SKIP); do
                  FOLDER="$FOLDER/$(ls -1 $FOLDER | head -n 1)"
                  echo "Skipping folder level $i, now inside: $FOLDER"
              done
          fi

          if [ -d "$FOLDER/.github" ]; then
              rm -rf "$FOLDER/.github"
              echo "Removed .github from source to prevent collisions."
          fi

          shopt -s dotglob
          cp -a "$FOLDER"/* "$TARGET"/
          shopt -u dotglob

          rm -rf temp_extract
          rm source.zip

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Merged source from tag ${{ github.event.inputs.tag_version }}" || echo "No changes"
          git push
